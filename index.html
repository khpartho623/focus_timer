<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Lock Timer</title>
    

<script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js library for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* Custom CSS for Phone App Look */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #0d0c1d; /* Deep Dark Blue for space background */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Hide scrollbars caused by falling stars */
        }
        
        /* ---------------------------------- */
        /* STARFIELD ANIMATION STYLES (তারার অ্যানিমেশন) */
        /* ---------------------------------- */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Keep it behind the app container */
            pointer-events: none; /* Ignore mouse events */
        }
        
        .star {
            position: absolute;
            background-color: #ffffff;
            border-radius: 50%;
            box-shadow: 0 0 5px 2px rgba(255, 255, 255, 0.4); /* Subtle glow */
            opacity: 0;
            animation-name: shoot;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        @keyframes shoot {
            0% {
                transform: translate(0, 0) rotate(225deg);
                opacity: 1;
            }
            10% {
                opacity: 0.8;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                /* Travel diagonally down and right */
                transform: translate(calc(100vw + 300px), calc(100vh + 300px)) rotate(225deg);
                opacity: 0;
            }
        }
        /* ---------------------------------- */
        /* END STARFIELD STYLES */
        /* ---------------------------------- */


        #app {
            /* Background changed to semi-transparent to let stars show through */
            background-color: rgba(0, 0, 0, 0.3); 
            backdrop-filter: none; /* Removed blur for clearer star visibility */
            width: 90%; 
            max-width: 360px; 
            height: 100%;
            max-height: 780px; 
            min-height: 600px; 
            border-radius: 2rem; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin: 20px; 
            position: relative; 
            z-index: 1;
        }
        
        /* Ensure inner screens take up necessary space */
        #setup-screen, #lock-screen {
            width: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;
        }

        /* Specific styles for the "LOCKED" text */
        #lock-screen h1 {
            font-size: 1.1rem; 
            font-weight: 500; 
            color: #d1d5db; 
        }

        /* Specific styles for the description text */
        #lock-message {
            font-size: 0.85rem; 
            color: #9ca3af; 
            max-width: 280px; 
            line-height: 1.4; 
            font-weight: 400; 
        }

        /* Specific styles for the timer display */
        #timer-display {
            font-size: 5rem; 
            font-weight: 700; 
            color: #ef4444; 
            letter-spacing: -1px; 
        }

        /* Specific styles for the +1 Minute button */
        #add-minute-button {
            border: 1px solid #ff6347; 
            color: #ff6347;
            padding: 0.6rem 1.8rem; 
            border-radius: 9999px; 
            font-size: 0.9rem; 
            font-weight: 500; 
            transition: background-color 0.2s;
        }
        #add-minute-button:hover {
            background-color: rgba(255, 99, 71, 0.1);
        }
        
        /* New style for the Gemini feature output (Removed, but keeping the block for structure) */
        #focus-tip-output {
            min-height: 2.5rem; 
            transition: color 0.3s;
        }

    </style>
</head>
<body>

    <!-- Starfield Background (তারার ব্যাকগ্রাউন্ড) -->
    <div id="starfield"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Firebase config parsing error:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase Initialized for App ID:", appId);

            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }
            };
            authenticate();
        } else {
            console.warn("Firebase config not available. Running app without full persistence features.");
        }
    </script>
    

<div id="app" class="text-white">

        <!-- Page 1: Setup Screen (Setup Screen) -->
        <div id="setup-screen" class="p-6 flex flex-col items-center justify-center">
            
            <!-- Time Setting UI: Centralized display with Plus/Minus symbols (Shomoy set korar UI: Plus/Minus symbol soho modhyoborti display) -->
            <div class="flex items-center justify-center mb-10">
                
                <!-- Minus Button (Minus button) -->
                <button onclick="minusTime(5)" class="text-red-500 text-4xl p-2 hover:bg-red-500/10 active:scale-90 transition duration-150 mr-6 flex items-center justify-center font-bold" aria-label="Decrease time by 5 minutes">
                    &minus;
                </button>

                <!-- Time Display (Shomoy display) -->
                <div id="setup-time-setter" class="mx-auto">
                    <!-- Increased text size back to 7xl for prominence -->
                    <div id="set-time-display" class="text-7xl font-extralight text-red-500 leading-none p-2">
                        60
                    </div>
                </div>

                <!-- Plus Button (Plus button) -->
                <button onclick="plusTime(5)" class="text-red-500 text-4xl p-2 hover:bg-red-500/10 active:scale-90 transition duration-150 ml-6 flex items-center justify-center font-bold" aria-label="Increase time by 5 minutes">
                    +
                </button>
            </div>


            <!-- Hidden input to pass default time to the timer logic, updated by plus/minus (Hidden input) -->
            <input type="hidden" id="custom-minutes" value="60" min="1" />

            <!-- Start Button (Start button) -->
            <button onclick="startTimerFromSetup()" class="bg-orange-500 hover:bg-orange-600 text-black font-bold text-xl px-12 py-4 rounded-xl shadow-lg transition duration-150 mt-4">
                Start
            </button>
            
        </div>

        <!-- Page 2: Lock Screen (Lock Screen) -->
        <div id="lock-screen" class="hidden p-6">
            
            <!-- 1. Timer Display (Timer display) -->
            <div id="timer-display" class="text-7xl font-bold text-red-500 mb-8">
                00:00
            </div>

            <!-- 2. LOCKED Header (LOCKED header) -->
            <h1 class="text-xl font-medium text-gray-300 mb-1">
                LOCKED
            </h1>

            <!-- 3. Lock Message (Lock message) -->
            <p id="lock-message" class="text-sm text-gray-400 max-w-sm px-4 leading-relaxed mb-8">
                Your phone usage and notifications are restricted during this session. The lock will automatically release when the timer ends.
            </p>

            <!-- 4. +1 Minute Button (+1 Minute button) -->
            <button id="add-minute-button" class="timer-button mb-4" onclick="addTime(60)">
                +1 Minute
            </button>

            <!-- 5. Emergency Stop Button (Emergency Stop button) -->
            <button id="unlock-button" class="text-gray-500 text-sm mt-2 hover:text-gray-300 hidden" onclick="stopTimer(true)">
                Emergency Stop
            </button>

            <!-- Application Footer (Application Footer) -->
            <footer class="text-xs text-gray-500 text-center mt-12 w-full px-4">
                <p>&copy; 2025 All rights reserved. Powered by 
                    <a href="https://khpartho.github.io/me/" class="text-gray-400 hover:text-red-400 transition-colors" target="_blank">Partho</a>.
                </p>
            </footer>
        </div>
    </div>

    <script>
        // --- Timer State and Logic (Timer-er obostha o tar bebohar) ---
        const setupScreen = document.getElementById('setup-screen');
        const lockScreen = document.getElementById('lock-screen');
        const timerDisplay = document.getElementById('timer-display');
        const lockMessage = document.getElementById('lock-message');
        const addMinuteButton = document.getElementById('add-minute-button');
        const customMinutesInput = document.getElementById('custom-minutes'); // Hidden input
        
        // New elements for tap-to-set (Shomoy set korar notun element)
        const setTimeDisplay = document.getElementById('set-time-display');
        const setupTimeSetter = document.getElementById('setup-time-setter');
        
        let intervalId = null;
        let timeRemaining = 0; // Time in seconds (Shomoy second-e)
        let wakeLock = null; // Variable to hold the screen wake lock (Screen wake lock dhorar jonno variable)
        
        const MIN_TIME = 1; // 1 minute (1 minute)
        const MAX_TIME = 300; // 300 minutes (5 hours) (300 minute)
        let currentSetMinutes = 60; // Default minutes set to 60 (Default 60 minute set kora)

        // Initialize Tone.js components for sound (Sound-er jonno Tone.js initialize kora)
        let synth = null;
        
        // Starfield elements
        const starfield = document.getElementById('starfield');
        const numStars = 20; // Number of shooting stars (Koto gulo tara khosbe)

        /**
         * Initializes the Tone.js synth if not already initialized. (Tone.js initialize kora)
         */
        async function initializeSynth() {
            if (!synth) {
                try {
                    // Start the AudioContext
                    await Tone.start();
                    // Create a simple synth
                    synth = new Tone.Synth({
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }
                    }).toDestination();
                    console.log("AudioContext is running and Synth is initialized.");
                } catch (e) {
                    console.error("Error initializing Tone.js:", e);
                }
            }
        }

        /**
         * Plays the sound for starting a focus session (Upward C5, E5, G5). (Focus session shuru korar sound bajano)
         */
        function playFocusStartSound() {
            if (!synth || Tone.context.state !== 'running') {
                console.warn("Synth not ready to play start sound.");
                return;
            }

            const notes = ["C5", "E5", "G5"]; // Upward (Energetic start)
            const duration = "8n";
            const delay = 0.2; 

            let time = Tone.now();
            synth.triggerAttackRelease(notes[0], duration, time);
            synth.triggerAttackRelease(notes[1], duration, time + delay);
            synth.triggerAttackRelease(notes[2], duration, time + delay * 2);
        }
        
        /**
         * Plays the sound for session completion (quadruple 'tung tung'). (Session sesh hobar sound, char bar)
         */
        function playFocusEndSequence() {
            if (!synth || Tone.context.state !== 'running') {
                console.warn("Synth not ready to play end sound.");
                return;
            }

            // Play 1st (Prothom bar)
            playFocusStartSound();

            // Play 2nd after 1s (Ditiyo bar 1s por)
            setTimeout(() => {
                playFocusStartSound();
            }, 1000); 
            
            // Play 3rd after 2s (Tritiyo bar 2s por)
            setTimeout(() => {
                playFocusStartSound();
            }, 2000);
            
            // Play 4th after 3s (Choturtho bar 3s por)
            setTimeout(() => {
                playFocusStartSound();
            }, 3000);
        }

        /**
         * Creates and initializes the shooting star animations. (Shooting star animation toiri kora)
         */
        function createStars() {
            if (!starfield) return;

            // Clear previous stars if any (Jodi kono aager tara thake, muche dewa)
            starfield.innerHTML = ''; 

            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';

                // Random size (0.5px to 2px)
                const size = Math.random() * 1.5 + 0.5; 
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;

                // Random position (Mostly top-left quadrant for diagonal travel)
                // Use random number generation up to 100% of viewport width/height
                // Using document.documentElement.clientWidth/Height for compatibility
                const clientW = document.documentElement.clientWidth;
                const clientH = document.documentElement.clientHeight;
                
                const startX = Math.random() * clientW * 1.5 - (clientW * 0.5); 
                const startY = Math.random() * clientH * 1.5 - (clientH * 0.5); 
                
                // Adjust position to ensure they start off-screen slightly
                star.style.left = `${startX}px`;
                star.style.top = `${startY}px`;

                // Random animation duration (3s to 8s) and delay
                const duration = Math.random() * 5 + 3; 
                const delay = Math.random() * 20; 
                
                star.style.animationDuration = `${duration}s`;
                star.style.animationDelay = `${delay}s`;

                starfield.appendChild(star);
            }
        }


        // --- Wake Lock Functions (Wake Lock Functions) ---
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen Wake Lock acquired');
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen Wake Lock released');
                    });
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }
        };

        const releaseWakeLock = () => {
            if (wakeLock) {
                wakeLock.release()
                    .then(() => {
                        wakeLock = null;
                    });
            }
        };
        
        // --- Time Setter Logic (Shomoy set korar logic) ---

        /**
         * Updates the display element and the hidden input for the set time. (Shomoy display o hidden input update kora)
         */
        function updateSetTimeDisplay() {
            setTimeDisplay.textContent = currentSetMinutes;
            customMinutesInput.value = currentSetMinutes; // Sync value for start logic
        }

        /**
         * Increments the focus time by the specified minutes. (Shomoy barano)
         * @param {number} minutes
         */
        function plusTime(minutes) {
            currentSetMinutes += minutes;
            if (currentSetMinutes > MAX_TIME) {
                currentSetMinutes = MAX_TIME;
            }
            updateSetTimeDisplay();
        }

        /**
         * Decrements the focus time by the specified minutes. (Shomoy komano)
         * @param {number} minutes
         */
        function minusTime(minutes) {
            currentSetMinutes -= minutes;
            if (currentSetMinutes < MIN_TIME) {
                currentSetMinutes = MIN_TIME;
            }
            updateSetTimeDisplay();
        }


        // --- Timer Core Logic (Timer-er mul logic) ---
        
        /**
         * Formats seconds into MM:SS string. (Second-ke MM:SS string-e rupantor kora)
         * @param {number} totalSeconds
         * @returns {string}
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(seconds)}`;
        }

        /**
         * Updates the timer display on the lock screen. (Timer display update kora)
         */
        function updateDisplay() {
            if (timeRemaining < 0) timeRemaining = 0;
            timerDisplay.textContent = formatTime(timeRemaining);
        }

        /**
         * Main timer countdown logic. (Mul countdown logic)
         */
        function countdown() {
            if (timeRemaining <= 0) {
                stopTimer();
            } else {
                timeRemaining--;
                updateDisplay();
            }
        }

        /**
         * Starts the timer and switches to the lock screen. (Timer shuru kora o lock screen-e jawa)
         */
        function startTimer() {
            if (timeRemaining <= 0) return;

            // Trigger sound at the start (Upward C5, E5, G5) (Shurute sound bajano)
            playFocusStartSound(); 

            // Request screen wake lock (Screen wake lock anurodh kora)
            requestWakeLock();

            // Page transition: Hide setup, show lock screen (Page poriborton)
            setupScreen.classList.add('hidden');
            lockScreen.classList.remove('hidden');

            // Reset messages and styling (Message o styling reset kora)
            lockMessage.textContent = 'Your phone usage and notifications are restricted during this session. The lock will automatically release when the timer ends.';
            addMinuteButton.classList.remove('hidden');
            document.getElementById('unlock-button').classList.remove('hidden'); // Show emergency stop button (Emergency stop button dekhano)
            timerDisplay.classList.remove('text-green-500', 'text-gray-400');
            timerDisplay.classList.add('text-red-500');

            // Start the interval (Interval shuru kora)
            intervalId = setInterval(countdown, 1000);
            updateDisplay();
        }

        /**
         * Stops the timer and shows the result/switches back to setup. (Timer thamiye result dekhano)
         * @param {boolean} emergencyStop
         */
        function stopTimer(emergencyStop = false) {
            clearInterval(intervalId);
            intervalId = null;

            // Release screen wake lock (Screen wake lock release kora)
            releaseWakeLock();

            if (emergencyStop) {
                // Emergency stop - NO SOUND (Joruri thama - kono shobdo nei)
                lockMessage.textContent = 'Emergency stop initiated. Click below to start a new session.';
                timerDisplay.textContent = '00:00';
                timerDisplay.classList.remove('text-red-500', 'text-green-500');
                timerDisplay.classList.add('text-gray-400');
            } else {
                // Normal completion - PLAY QUADRUPLE START SOUND (Shadharon shesh - char bar sound bajano)
                playFocusEndSequence(); 
                lockMessage.textContent = "Time's up! Click anywhere to start a new session.";
                timerDisplay.textContent = '00:00';
                timerDisplay.classList.remove('text-red-500', 'text-gray-400');
                timerDisplay.classList.add('text-green-500'); // Green color for completion (Shesh hobar jonno shobuj rong)
            }

            // Hide action buttons when timer stops (Timer thamle button gulo lukono)
            addMinuteButton.classList.add('hidden');
            document.getElementById('unlock-button').classList.add('hidden');


            // Allow user to click anywhere on the lock screen to return to setup (Click korle setup-e phire jawa)
            lockScreen.onclick = returnToSetup;
        }

        /**
         * Adds time to the current countdown. (Countdown-e shomoy jog kora)
         * @param {number} seconds
         */
        function addTime(seconds) {
            timeRemaining += seconds;
            updateDisplay();
        }

        /**
         * Gets time from input and starts the timer. (Input theke shomoy niye timer shuru kora)
         */
        async function startTimerFromSetup() {
            // Read value from hidden input which is synced by the button logic. (Hidden input theke value pora)
            const minutes = parseInt(customMinutesInput.value, 10); 
            
            if (isNaN(minutes) || minutes <= 0) {
                console.error("Invalid time set.");
                return;
            }
            
            // Critical fix: Initialize AudioContext right on the Start button click (Start button click-e AudioContext initialize kora)
            await initializeSynth();

            timeRemaining = minutes * 60;
            startTimer();
        }

        /**
         * Returns the view to the setup screen. (Setup screen-e phire jawa)
         */
        function returnToSetup() {
            lockScreen.onclick = null; // Remove the listener (Listener shoriye dewa)
            lockScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            currentSetMinutes = 60; // Reset setter state to default 60 (Setter obostha reset kora)
            timeRemaining = 0; // Reset time (Shomoy reset kora)
            updateSetTimeDisplay(); // Update setter display (Setter display update kora)
            updateDisplay(); // Ensure lock screen display is reset (Lock screen display reset ensure kora)
        }

        // --- Initial Setup (Runs immediately after script loads) (Prothomik setup) ---
        
        // Initialize the starfield and display once the DOM is fully loaded (DOM load howar por starfield o display initialize kora)
        document.addEventListener('DOMContentLoaded', () => {
             try {
                createStars();
                // Ensure initial display is set. (Prothomik display set kora ensure kora)
                updateSetTimeDisplay(); 
                console.log("Focus Lock Timer script initialized and ready.");
             } catch(e) {
                console.error("Initialization Error:", e);
             }
        });

    </script>
</body>
</html>

